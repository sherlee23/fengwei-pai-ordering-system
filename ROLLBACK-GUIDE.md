# 🎯 采购订单回滚功能 - 快速使用指南

## 📍 在哪里找到？

1. 进入系统后台
2. 点击"采购订单管理"
3. 在采购单列表中，找到需要回滚的订单
4. 在"操作"列，你会看到 **红色的"回滚整单"按钮**

---

## 🔘 按钮显示条件

回滚整单按钮只会在以下状态的采购单显示：
- ✅ **部分收货**（`partial`）- 已部分入库的采购单
- ✅ **已完成**（`completed`）- 已全部入库的采购单

**不显示的情况**：
- ❌ 待收货（`pending`）- 还没有入库记录
- ❌ 已取消（`cancelled`）- 已取消的采购单

---

## 📖 使用步骤

### 步骤 1：点击"回滚整单"按钮
在采购单列表找到需要回滚的订单，点击红色的"回滚整单"按钮。

### 步骤 2：查看确认对话框
系统会弹出确认对话框，显示：
```
⚠️ 确认回滚整个采购订单的所有入库操作？

采购单号：PO-20241222-001
需要回滚的产品：
  • 锋味派月饼: 50 件
  • 锋味派红豆酥饼: 30 件
  • 锋味派绿豆酥饼: 20 件

共 3 个产品，总计 100 件货物

⚠️ 注意：此操作不可撤销！
```

### 步骤 3：确认回滚
- 点击"确定" → 开始执行回滚
- 点击"取消" → 取消操作

### 步骤 4：查看回滚结果
系统会显示详细的回滚结果：

**全部成功**：
```
✅ 采购单回滚成功！共回滚 3 条入库记录
```

**部分成功**：
```
⚠️ 部分回滚成功
成功: 2 条
失败: 1 条

失败详情:
锋味派月饼: 库存不足 (当前库存：10，需要：50)
```

**全部失败**：
```
❌ 回滚失败
锋味派月饼: 库存不足 (当前库存：10，需要：50)
锋味派红豆酥饼: 产品不存在
```

---

## 🔍 回滚后会发生什么？

### 1. 库存自动减少
每个产品的库存会减少相应的数量，恢复到入库前的状态。

**例如**：
- 入库前：锋味派月饼库存 = 50
- 入库后：锋味派月饼库存 = 100 (+50)
- 回滚后：锋味派月饼库存 = 50 (-50) ✅ 恢复原状

### 2. 创建回滚流水记录
系统会自动创建一条"回滚"类型的流水记录，记录：
- 🔖 回滚原因：回滚采购单 XXX
- 📅 回滚时间
- 🔗 关联原入库记录 ID
- 📝 详细备注信息

### 3. 页面自动刷新
回滚完成后，系统会自动刷新：
- 采购单列表
- 流水记录列表
- 产品库存数据

---

## ⚠️ 常见问题

### Q1: 为什么我看不到"回滚整单"按钮？
**A**: 只有"部分收货"或"已完成"状态的采购单才显示回滚按钮。如果采购单是"待收货"状态，说明还没有任何入库记录，无需回滚。

### Q2: 点击回滚后提示"没有任何入库记录"？
**A**: 这说明该采购单的入库记录已经被删除或移动，系统无法找到对应的入库流水。请联系管理员检查数据。

### Q3: 回滚时提示"已被回滚过了"？
**A**: 这个采购单的所有入库记录都已经被回滚过了，无法重复回滚。系统自动防止重复操作。

### Q4: 回滚失败，提示"库存不足"？
**A**: 这说明某些产品的当前库存少于需要回滚的数量。可能原因：
- 回滚后产品已经被卖出
- 产品已经被其他操作减少了库存
- 需要先补充库存才能回滚

**解决方法**：
1. 检查产品的当前库存
2. 如果库存确实不足，考虑是否要继续回滚其他产品
3. 系统会跳过库存不足的产品，继续回滚其他产品

### Q5: 回滚后能再恢复吗？
**A**: 不能！回滚操作是**不可逆的**。如果误操作，需要重新创建入库记录。建议：
- 回滚前仔细确认采购单号
- 查看确认对话框中的产品列表
- 确保是你要回滚的正确订单

### Q6: 部分回滚成功，部分失败，怎么办？
**A**: 系统会显示详细的失败原因。你可以：
1. 查看哪些产品回滚失败
2. 解决失败原因（例如补充库存）
3. 再次点击"回滚整单"，系统会自动跳过已回滚的产品

---

## 💡 使用技巧

### 技巧 1：回滚前先查看流水记录
在"流水记录"标签页，可以看到该采购单的所有入库记录，确认后再回滚。

### 技巧 2：利用部分回滚机制
如果某些产品库存不足，系统会自动跳过。你可以：
1. 先回滚库存充足的产品
2. 补充库存不足的产品
3. 再次回滚剩余产品

### 技巧 3：查看回滚记录
回滚后，在"流水记录"中可以看到回滚流水，类型为"回滚"，方便后续审计。

---

## 🎬 实际案例

### 案例 1：整单入库错误
**场景**：不小心把 PO-20241222-001 的货物入库到 PO-20241222-002
**解决**：
1. 找到 PO-20241222-002
2. 点击"回滚整单"
3. 确认回滚
4. 重新对 PO-20241222-001 执行收货入库

### 案例 2：供应商退货
**场景**：收货后发现质量问题，供应商要求退货
**解决**：
1. 找到对应的采购单
2. 点击"回滚整单"
3. 库存恢复到收货前
4. 联系供应商安排退货

### 案例 3：测试数据清理
**场景**：测试时创建了多个采购单并执行了入库
**解决**：
1. 逐个找到测试采购单
2. 点击"回滚整单"
3. 库存恢复正常
4. 可以继续测试或清理采购单

---

## 📞 需要帮助？

如果遇到问题，请：
1. 查看浏览器控制台的错误信息（按 F12）
2. 截图错误提示
3. 记录采购单号和操作步骤
4. 联系技术支持

---

## ✅ 回滚前检查清单

- [ ] 确认采购单号正确
- [ ] 确认要回滚的产品列表
- [ ] 确认当前库存充足
- [ ] 确认回滚操作必要性
- [ ] 已知回滚操作不可撤销

**准备好了？点击"回滚整单"吧！** 🚀
