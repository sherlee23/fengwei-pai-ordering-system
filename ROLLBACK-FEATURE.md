# ğŸ”„ é‡‡è´­è®¢å•å›æ»šåŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨é‡‡è´­ç®¡ç†ç•Œé¢æ–°å¢äº†"å›æ»šæ•´å•"åŠŸèƒ½ï¼Œå¯ä»¥ä¸€é”®æ’¤é”€æ•´ä¸ªé‡‡è´­è®¢å•çš„æ‰€æœ‰å…¥åº“æ“ä½œï¼Œé¿å…æ‰‹åŠ¨é€æ¡å›æ»šçš„é”™è¯¯å’Œéº»çƒ¦ã€‚

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1ï¸âƒ£ å›æ»šæ•´å•æŒ‰é’®

**ä½ç½®**ï¼šé‡‡è´­å•åˆ—è¡¨ > æ“ä½œåˆ—
**æ˜¾ç¤ºæ¡ä»¶**ï¼šåªæœ‰"éƒ¨åˆ†æ”¶è´§"æˆ–"å·²å®Œæˆ"çŠ¶æ€çš„é‡‡è´­å•æ‰æ˜¾ç¤ºæ­¤æŒ‰é’®
**æŒ‰é’®æ ·å¼**ï¼šçº¢è‰²æŒ‰é’®ï¼Œå›¾æ ‡ä¸º ğŸ”„ (undo)

```tsx
{(po.status === 'partial' || po.status === 'completed') && (
    <button
        onClick={() => reversePurchaseOrder(po.purchase_order_id)}
        disabled={loading}
        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs"
        title="å›æ»šæ•´å• - æ’¤é”€æ‰€æœ‰å…¥åº“æ“ä½œ"
    >
        <i className="fas fa-undo mr-1"></i>
        å›æ»šæ•´å•
    </button>
)}
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼š`reversePurchaseOrder`

### åŠŸèƒ½è¯´æ˜

æ‰¹é‡å›æ»šä¸€ä¸ªé‡‡è´­è®¢å•çš„æ‰€æœ‰å…¥åº“è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… è‡ªåŠ¨æŸ¥æ‰¾è¯¥é‡‡è´­å•çš„æ‰€æœ‰å…¥åº“è®°å½•
- âœ… è¿‡æ»¤æ‰å·²å›æ»šçš„è®°å½•ï¼ˆé˜²æ­¢é‡å¤å›æ»šï¼‰
- âœ… é€ä¸ªæ’¤é”€åº“å­˜å˜æ›´
- âœ… åˆ›å»ºå›æ»šæµæ°´è®°å½•ï¼ˆä½¿ç”¨ `reversal_of` å­—æ®µå…³è”åŸè®°å½•ï¼‰
- âœ… è¯¦ç»†çš„æˆåŠŸ/å¤±è´¥åé¦ˆ

### å®ç°é€»è¾‘

```typescript
const reversePurchaseOrder = async (purchaseOrderId: string) => {
    // 1. é€šè¿‡ notes å­—æ®µæ¨¡ç³ŠåŒ¹é…æŸ¥æ‰¾å…¥åº“è®°å½•
    const { data: transactions } = await supabase
        .from('stock_transactions')
        .select('*, product:product_id(name, emoji)')
        .eq('transaction_type', 'stock_in')
        .ilike('notes', `%${purchaseOrderId}%`)
        .order('created_at', { ascending: true });

    // 2. æ£€æŸ¥æ¯æ¡è®°å½•æ˜¯å¦å·²è¢«å›æ»š
    const notReversedTransactions = [];
    for (const transaction of transactions) {
        const { data: existingReversal } = await supabase
            .from('stock_transactions')
            .select('id')
            .eq('reversal_of', transaction.id)
            .single();
        
        if (!existingReversal) {
            notReversedTransactions.push(transaction);
        }
    }

    // 3. ç”¨æˆ·ç¡®è®¤
    if (!window.confirm(`ç¡®è®¤å›æ»š ${notReversedTransactions.length} æ¡è®°å½•ï¼Ÿ`)) {
        return;
    }

    // 4. é€ä¸ªå›æ»š
    for (const transaction of notReversedTransactions) {
        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        // æ›´æ–°åº“å­˜
        // åˆ›å»ºå›æ»šè®°å½•ï¼ˆåŒ…å« reversal_of å­—æ®µï¼‰
    }

    // 5. æ˜¾ç¤ºè¯¦ç»†ç»“æœ
    // æˆåŠŸæ•° / å¤±è´¥æ•° / å¤±è´¥åŸå› 
}
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. é˜²é‡å¤å›æ»š
- ä½¿ç”¨ `reversal_of` å­—æ®µæ ‡è®°å·²å›æ»šçš„è®°å½•
- æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²å›æ»šçš„å…¥åº“è®°å½•
- å¦‚æœæ‰€æœ‰è®°å½•éƒ½å·²å›æ»šï¼Œæ˜¾ç¤ºæç¤ºå¹¶ç»ˆæ­¢æ“ä½œ

### 2. åº“å­˜ä¸è¶³æ£€æŸ¥
- å›æ»šå‰éªŒè¯æ¯ä¸ªäº§å“çš„å½“å‰åº“å­˜æ˜¯å¦å……è¶³
- å¦‚æœåº“å­˜ä¸è¶³ï¼Œè·³è¿‡è¯¥äº§å“å¹¶åœ¨ç»“æœä¸­æŠ¥å‘Š

### 3. ç”¨æˆ·ç¡®è®¤
- æ˜¾ç¤ºè¯¦ç»†çš„å›æ»šä¿¡æ¯ï¼ˆäº§å“åç§°ã€æ•°é‡ã€æ€»ä»¶æ•°ï¼‰
- æ˜ç¡®æç¤º"æ­¤æ“ä½œä¸å¯æ’¤é”€"
- éœ€è¦ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æ‰èƒ½æ‰§è¡Œ

### 4. è¯¦ç»†æ—¥å¿—
- æ¯ä¸ªæ­¥éª¤éƒ½æœ‰ console.log è®°å½•
- æˆåŠŸ/å¤±è´¥ç»“æœåˆ†åˆ«è®°å½•
- ä¾¿äºåç»­æ’æŸ¥é—®é¢˜

---

## ğŸ“Š å›æ»šè®°å½•æ ¼å¼

```javascript
{
    product_id: 123,
    transaction_type: 'stock_adjustment_reversal',
    quantity: -50,                      // è´Ÿæ•°è¡¨ç¤ºå‡å°‘
    previous_stock: 100,
    new_stock: 50,
    reason: 'å›æ»šé‡‡è´­å• PO-20241222-001',
    operator: 'admin',
    notes: `æ‰¹é‡å›æ»šå…¥åº“æ“ä½œ
é‡‡è´­å•å·: PO-20241222-001
åŸå…¥åº“è®°å½• ID: abc123
äº§å“ï¼šé”‹å‘³æ´¾æœˆé¥¼
æ•°é‡ï¼š50
å›æ»šæ—¶é—´ï¼š2024-12-22 14:30:00`,
    reversal_of: 'abc123'              // ğŸ”‘ å…³é”®å­—æ®µï¼šå…³è”åŸå…¥åº“è®°å½•
}
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. é”™è¯¯å…¥åº“æ•´å•æ’¤é”€
- **åœºæ™¯**ï¼šä¸å°å¿ƒå¯¹é”™è¯¯çš„é‡‡è´­å•æ‰§è¡Œäº†æ”¶è´§å…¥åº“
- **æ“ä½œ**ï¼šç›´æ¥ç‚¹å‡»"å›æ»šæ•´å•"ï¼Œä¸€é”®æ’¤é”€æ‰€æœ‰å…¥åº“æ“ä½œ

### 2. ä¾›åº”å•†é€€è´§
- **åœºæ™¯**ï¼šæ”¶è´§åå‘ç°è´¨é‡é—®é¢˜ï¼Œéœ€è¦æ•´æ‰¹é€€è´§
- **æ“ä½œ**ï¼šå›æ»šæ•´å•ï¼Œåº“å­˜è‡ªåŠ¨æ¢å¤åˆ°æ”¶è´§å‰çŠ¶æ€

### 3. æµ‹è¯•æ•°æ®æ¸…ç†
- **åœºæ™¯**ï¼šæµ‹è¯•æ—¶åˆ›å»ºäº†å¤§é‡é‡‡è´­å…¥åº“è®°å½•
- **æ“ä½œ**ï¼šæ‰¹é‡å›æ»šï¼Œæ— éœ€æ‰‹åŠ¨é€æ¡åˆ é™¤

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æŸ¥è¯¢æ–¹å¼
- é€šè¿‡ `notes` å­—æ®µæ¨¡ç³ŠåŒ¹é…é‡‡è´­å•å·ï¼ˆ`ilike '%PO-xxx%'`ï¼‰
- å› ä¸º `stock_transactions` è¡¨ç›®å‰æ²¡æœ‰ `purchase_order_id` å­—æ®µ
- æœªæ¥å¯ä»¥ä¼˜åŒ–ï¼šæ·»åŠ  `purchase_order_id` å¤–é”®ï¼Œæé«˜æŸ¥è¯¢å‡†ç¡®æ€§

### 2. åº“å­˜ä¸è¶³å¤„ç†
- å¦‚æœæŸä¸ªäº§å“åº“å­˜ä¸è¶³ï¼Œè¯¥äº§å“ä¼šè·³è¿‡ä¸å›æ»š
- å…¶ä»–äº§å“ä¼šç»§ç»­å›æ»š
- æœ€ç»ˆç»“æœä¼šæ˜¾ç¤ºæˆåŠŸå’Œå¤±è´¥çš„è¯¦ç»†ä¿¡æ¯

### 3. æ“ä½œä¸å¯é€†
- å›æ»šæ“ä½œæ‰§è¡Œåæ— æ³•æ’¤é”€
- å»ºè®®åœ¨æ“ä½œå‰ç¡®è®¤é‡‡è´­å•å·å’Œäº§å“åˆ—è¡¨

### 4. å·²å›æ»šè®°å½•
- å·²å›æ»šçš„è®°å½•ä¸ä¼šé‡å¤å›æ»š
- ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤æ‰å·²æœ‰ `reversal_of` å…³è”çš„è®°å½•

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ  `purchase_order_id` å­—æ®µ
åœ¨ `stock_transactions` è¡¨æ·»åŠ å¤–é”®ï¼Œæé«˜æŸ¥è¯¢å‡†ç¡®æ€§ï¼š

```sql
ALTER TABLE stock_transactions 
ADD COLUMN purchase_order_id VARCHAR;

-- ä¸ºå·²æœ‰è®°å½•è¡¥å…… purchase_order_idï¼ˆå¯é€‰ï¼‰
UPDATE stock_transactions
SET purchase_order_id = (
    SELECT regexp_match(notes, 'PO-\d{8}-\d{3}')[1]
    WHERE notes ILIKE '%PO-%'
);

-- æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_stock_transactions_po_id 
ON stock_transactions(purchase_order_id);
```

### 2. æ›´æ–°å…¥åº“ä»£ç 
åœ¨æ‰€æœ‰å…¥åº“æ“ä½œæ—¶åŒæ—¶è®°å½• `purchase_order_id`ï¼š

```typescript
const { error } = await supabase
    .from('stock_transactions')
    .insert([{
        // ...existing fields...
        purchase_order_id: po.purchase_order_id  // æ–°å¢
    }]);
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
å¦‚æœé‡‡è´­å•äº§å“å¾ˆå¤šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ‰¹é‡æ›´æ–°ï¼š

```typescript
// æ‰¹é‡æ›´æ–°åº“å­˜ï¼ˆéœ€è¦ Supabase RPC å‡½æ•°ï¼‰
await supabase.rpc('batch_update_stock', {
    updates: [
        { product_id: 1, quantity_delta: -50 },
        { product_id: 2, quantity_delta: -30 },
        // ...
    ]
});
```

---

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] å›æ»šæŒ‰é’®åªåœ¨"éƒ¨åˆ†æ”¶è´§"å’Œ"å·²å®Œæˆ"çŠ¶æ€æ˜¾ç¤º
- [ ] ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®çš„ç¡®è®¤å¯¹è¯æ¡†
- [ ] å›æ»šååº“å­˜æ­£ç¡®å‡å°‘
- [ ] å›æ»šè®°å½•æ­£ç¡®åˆ›å»ºï¼ˆåŒ…å« `reversal_of` å­—æ®µï¼‰
- [ ] é‡å¤ç‚¹å‡»"å›æ»šæ•´å•"æç¤º"å·²å›æ»š"
- [ ] åº“å­˜ä¸è¶³æ—¶æ­£ç¡®æç¤ºå¹¶è·³è¿‡
- [ ] éƒ¨åˆ†æˆåŠŸæ—¶æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸ/å¤±è´¥ä¿¡æ¯
- [ ] å›æ»šåé‡‡è´­å•åˆ—è¡¨å’Œæµæ°´è®°å½•è‡ªåŠ¨åˆ·æ–°

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æ·»åŠ "å›æ»šæ•´å•"åŠŸèƒ½ï¼Œé‡‡è´­ç®¡ç†æ›´åŠ å®Œå–„å’Œçµæ´»ï¼š
- âœ… èŠ‚çœæ—¶é—´ï¼šä¸€é”®å›æ»šæ‰€æœ‰å…¥åº“è®°å½•
- âœ… å‡å°‘é”™è¯¯ï¼šé¿å…æ‰‹åŠ¨é€æ¡å›æ»šå¯¼è‡´çš„é—æ¼
- âœ… å®‰å…¨å¯é ï¼šé˜²é‡å¤å›æ»šã€åº“å­˜éªŒè¯ã€è¯¦ç»†åé¦ˆ
- âœ… æ“ä½œç®€å•ï¼šç›´æ¥åœ¨é‡‡è´­å•åˆ—è¡¨ç‚¹å‡»æŒ‰é’®å³å¯

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸŠ
