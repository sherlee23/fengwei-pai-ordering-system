# ğŸ”„ åº“å­˜å›æ»šé€»è¾‘å›¾è§£

## ğŸ“Š reversal_of å­—æ®µçš„å·¥ä½œåŸç†

### åœºæ™¯ç¤ºä¾‹ï¼šå›æ»šä¸€ä¸ªæ‰‹åŠ¨è°ƒæ•´æ“ä½œ

```
æ—¶é—´è½´ï¼š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ­¥éª¤ 1: ç”¨æˆ·åˆ›å»ºæ‰‹åŠ¨è°ƒæ•´è®°å½•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stock_transactions è¡¨                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: aaa-111                                                  â”‚
â”‚ transaction_type: 'manual_adjustment'                       â”‚
â”‚ quantity: -5                                                â”‚
â”‚ previous_stock: 100                                         â”‚
â”‚ new_stock: 95                                               â”‚
â”‚ reversal_of: null  â† è¿™æ˜¯ä¸€ä¸ªæ™®é€šæ“ä½œï¼Œæ²¡æœ‰å›æ»šå…³ç³»         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UI æ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰‹åŠ¨è°ƒæ•´ | -5 | [å›æ»š] æŒ‰é’®       â”‚  â† canReverse = true
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ­¥éª¤ 2: ç”¨æˆ·ç‚¹å‡»å›æ»šæŒ‰é’®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç³»ç»Ÿåˆ›å»ºæ–°çš„å›æ»šè®°å½•ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stock_transactions è¡¨                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®°å½• 1 (åŸå§‹)                                                â”‚
â”‚ ID: aaa-111                                                  â”‚
â”‚ transaction_type: 'manual_adjustment'                       â”‚
â”‚ quantity: -5                                                â”‚
â”‚ reversal_of: null                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®°å½• 2 (æ–°åˆ›å»ºçš„å›æ»šè®°å½•)                                    â”‚
â”‚ ID: bbb-222                                                  â”‚
â”‚ transaction_type: 'stock_adjustment_reversal'               â”‚
â”‚ quantity: +5  â† åå‘æ“ä½œ                                    â”‚
â”‚ reversal_of: aaa-111  â† ğŸ”‘ æŒ‡å‘è¢«å›æ»šçš„è®°å½•ï¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UI æ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰‹åŠ¨è°ƒæ•´ | -5 | [å·²å›æ»š] ç°è‰²      â”‚  â† canReverse = false
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è°ƒæ•´å›æ»š | +5 | ä¸å¯å›æ»š           â”‚  â† å›æ»šæ“ä½œæœ¬èº«ä¸èƒ½å›æ»š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” isReversed åˆ¤æ–­é€»è¾‘å¯¹æ¯”

### âŒ é”™è¯¯çš„é€»è¾‘ï¼ˆä¿®å¤å‰ï¼‰

```javascript
const isReversed = !!trans.reversal_of;
```

**é—®é¢˜ï¼š** æ£€æŸ¥çš„æ˜¯å½“å‰è®°å½•è‡ªå·±çš„ `reversal_of` å­—æ®µ

```
æ£€æŸ¥è®°å½• aaa-111ï¼š
  aaa-111.reversal_of = null
  !!null = false
  â†’ isReversed = false  âœ… æ­£ç¡®

æ£€æŸ¥è®°å½• bbb-222ï¼š
  bbb-222.reversal_of = 'aaa-111'
  !!'aaa-111' = true
  â†’ isReversed = true  âŒ é”™è¯¯ï¼è¿™æ˜¯å›æ»šè®°å½•ï¼Œä¸æ˜¯è¢«å›æ»šçš„è®°å½•
```

### âœ… æ­£ç¡®çš„é€»è¾‘ï¼ˆä¿®å¤åï¼‰

```javascript
const isReversed = stockTransactions.some(t => t.reversal_of === trans.id);
```

**æ­£ç¡®ï¼š** æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è®°å½•æŒ‡å‘å½“å‰è®°å½•

```
æ£€æŸ¥è®°å½• aaa-111ï¼š
  æŸ¥æ‰¾æ‰€æœ‰è®°å½•ï¼Œæ˜¯å¦æœ‰ reversal_of === 'aaa-111'
  æ‰¾åˆ°ï¼šbbb-222.reversal_of === 'aaa-111'
  â†’ isReversed = true  âœ… æ­£ç¡®ï¼aaa-111 å·²è¢«å›æ»š

æ£€æŸ¥è®°å½• bbb-222ï¼š
  æŸ¥æ‰¾æ‰€æœ‰è®°å½•ï¼Œæ˜¯å¦æœ‰ reversal_of === 'bbb-222'
  æ²¡æ‰¾åˆ°
  â†’ isReversed = false  âœ… æ­£ç¡®ï¼bbb-222 æ²¡æœ‰è¢«å›æ»š
```

---

## ğŸ¯ canReverse å®Œæ•´åˆ¤æ–­æµç¨‹

```javascript
const canReverse = [
    'manual_adjustment', 
    'manual_in', 
    'manual_out', 
    'stock_adjustment', 
    'partial_delivery', 
    'manual_order',
    'order',
    'stock_out',
    'stock_in'
].includes(trans.transaction_type) && !isReversed;
```

### åˆ¤æ–­æµç¨‹å›¾

```
                    å¼€å§‹åˆ¤æ–­ canReverse
                           â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æ£€æŸ¥ transaction_type   â”‚
              â”‚ æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼Ÿ       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“           â†“
                   YES          NO
                     â†“           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  [ä¸å¯å›æ»š]
        â”‚ æ£€æŸ¥ isReversed    â”‚
        â”‚ (æ˜¯å¦å·²è¢«å›æ»š)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“           â†“
            false       true
              â†“           â†“
        [å¯ä»¥å›æ»š]    [å·²å›æ»š]
        æ˜¾ç¤ºå›æ»šæŒ‰é’®   æ˜¾ç¤ºå·²å›æ»šæ ‡è®°
```

---

## ğŸ“‹ å„ç§æƒ…å†µçš„UIè¡¨ç°

### æƒ…å†µ 1: æ™®é€šæ“ä½œï¼Œæœªå›æ»š
```
è®°å½•ï¼š
  transaction_type: 'manual_adjustment'
  reversal_of: null
  
æ£€æŸ¥ï¼š
  isReversed = false (æ²¡æœ‰å…¶ä»–è®°å½•æŒ‡å‘å®ƒ)
  canReverse = true
  
UIï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ‰‹åŠ¨è°ƒæ•´ | -5 | [å›æ»š]  â”‚  â† è“è‰²æŒ‰é’®ï¼Œå¯ç‚¹å‡»
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒ…å†µ 2: å·²è¢«å›æ»šçš„æ“ä½œ
```
è®°å½•ï¼š
  transaction_type: 'manual_adjustment'
  reversal_of: null
  
æ£€æŸ¥ï¼š
  isReversed = true (æœ‰å…¶ä»–è®°å½•çš„ reversal_of æŒ‡å‘å®ƒ)
  canReverse = false
  
UIï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ‰‹åŠ¨è°ƒæ•´ | -5 | [å·²å›æ»š]    â”‚  â† ç°è‰²æ–‡å­—ï¼Œä¸å¯ç‚¹å‡»
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒ…å†µ 3: å›æ»šæ“ä½œæœ¬èº«
```
è®°å½•ï¼š
  transaction_type: 'stock_adjustment_reversal'
  reversal_of: 'aaa-111'
  
æ£€æŸ¥ï¼š
  ç±»å‹ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­
  canReverse = false
  
UIï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ è°ƒæ•´å›æ»š | +5 | ä¸å¯å›æ»š     â”‚  â† ç´«è‰²æ ‡ç­¾
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒ…å†µ 4: ä¸æ”¯æŒå›æ»šçš„ç±»å‹
```
è®°å½•ï¼š
  transaction_type: 'purchase_order_in'
  reversal_of: null
  
æ£€æŸ¥ï¼š
  ç±»å‹ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­
  canReverse = false
  
UIï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ é‡‡è´­å…¥åº“ | +50 | ä¸å¯å›æ»š    â”‚  â† ç°è‰²æ–‡å­—
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— æ•°æ®å…³ç³»ç¤ºæ„å›¾

### ä¸€æ¬¡å›æ»šæ“ä½œçš„å®Œæ•´æ•°æ®å…³ç³»

```
                åŸå§‹æ“ä½œè®°å½•
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ID: aaa-111          â”‚
        â”‚ Type: manual_adjust  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Quantity: -5         â”‚           â”‚
        â”‚ reversal_of: null    â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                           â”‚
                                           â”‚ æŒ‡å‘
                                           â”‚
                å›æ»šè®°å½•                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
        â”‚ ID: bbb-222          â”‚           â”‚
        â”‚ Type: reversal       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Quantity: +5         â”‚
        â”‚ reversal_of: aaa-111 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢æ—¶ï¼š
  æ£€æŸ¥ aaa-111 æ˜¯å¦å·²è¢«å›æ»šï¼š
  â†’ éå†æ‰€æœ‰è®°å½•ï¼Œæ‰¾åˆ° bbb-222.reversal_of === 'aaa-111'
  â†’ ç»“è®ºï¼šaaa-111 å·²è¢«å›æ»š
```

---

## ğŸ’¡ å…³é”®ä»£ç å¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
```typescript
// âŒ æ£€æŸ¥è‡ªå·±çš„ reversal_of å­—æ®µ
const isReversed = !!trans.reversal_of;
const canReverse = [...].includes(trans.transaction_type) && !trans.reversal_of;
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
```typescript
// âœ… æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è®°å½•æŒ‡å‘è‡ªå·±
const isReversed = stockTransactions.some(t => t.reversal_of === trans.id);
const canReverse = [...].includes(trans.transaction_type) && !isReversed;
```

---

## ğŸ“ ç†è§£è¦ç‚¹

1. **reversal_of çš„å«ä¹‰ï¼š**
   - "æˆ‘æ˜¯è°çš„å›æ»šæ“ä½œ"
   - ä¸æ˜¯"æˆ‘è¢«è°å›æ»šäº†"

2. **isReversed çš„æ­£ç¡®åˆ¤æ–­ï¼š**
   - ä¸æ˜¯æ£€æŸ¥è‡ªå·±æ˜¯å¦æœ‰ reversal_of
   - è€Œæ˜¯æ£€æŸ¥æœ‰æ²¡æœ‰åˆ«äººçš„ reversal_of æŒ‡å‘è‡ªå·±

3. **é˜²æ­¢é‡å¤å›æ»šï¼š**
   - ä¸€æ—¦æœ‰è®°å½•çš„ reversal_of æŒ‡å‘æŸè®°å½•
   - é‚£æ¡è®°å½•å°±æ°¸ä¹…æ ‡è®°ä¸º"å·²å›æ»š"
   - ä¸èƒ½å†æ¬¡å›æ»š

4. **å›æ»šæ“ä½œæœ¬èº«ä¸èƒ½å›æ»šï¼š**
   - transaction_type === 'stock_adjustment_reversal'
   - è¿™äº›è®°å½•ä¸åœ¨ canReverse çš„ç±»å‹åˆ—è¡¨ä¸­

---

**å›¾è§£ç‰ˆæœ¬ï¼š** v1.0  
**ç›¸å…³æ–‡æ¡£ï¼š** ROLLBACK-FIX-FINAL.md, ROLLBACK-TEST-GUIDE.md
