# ✅ 解决芝士玉米烤肠问题 - 快速操作清单

## ⚡ 最新更新（重要）

**🎉 库存回滚功能已完全修复！**

- ✅ 修复了回滚按钮的显示逻辑
- ✅ 现在支持所有类型的库存操作回滚（订单出库、部分发货、手动调整等）
- ✅ 正确使用 `reversal_of` 字段防止重复回滚
- 📄 详细说明请查看：`ROLLBACK-FIX-FINAL.md`

---

## 🎯 你的具体问题

**症状**：
- ❌ 芝士玉米烤肠库存为 0
- ❌ 无法回滚采购订单的入库记录
- ❌ 之前因为供应商发错货手动调整过库存
- ❌ 某些订单的部分发货状态显示错误

**根本原因**：
1. 手动调整导致库存数据混乱
2. 部分发货后订单状态没有正确更新
3. 流水记录的数量符号可能有误

---

## 🚀 完整解决方案（按顺序执行）

### 步骤 1：修复数据库数据 ⚠️ 优先执行

#### 1.1 修复库存流水的数量符号
在 Supabase SQL Editor 执行：

```sql
-- 查看问题记录
SELECT 
    id, product_id, transaction_type, quantity, 
    previous_stock, new_stock, reason
FROM stock_transactions
WHERE 
    transaction_type IN ('stock_out', 'order', 'manual_order', 'partial_delivery')
    AND quantity > 0  -- 出库但数量为正（错误）
    AND new_stock < previous_stock  -- 库存确实减少了
ORDER BY created_at DESC;
```

如果有记录显示，执行修复：

```sql
-- 修复出库记录的数量符号
UPDATE stock_transactions
SET quantity = -ABS(quantity)
WHERE 
    transaction_type IN ('stock_out', 'order', 'manual_order', 'partial_delivery')
    AND quantity > 0
    AND new_stock < previous_stock;
```

#### 1.2 修复订单状态
```sql
-- 查看需要修复的订单
SELECT 
    o.id, o.order_id, o.name, o.status, COUNT(st.id) as delivery_count
FROM orders o
INNER JOIN stock_transactions st ON st.order_id = o.order_id 
    AND st.transaction_type IN ('partial_delivery', 'manual_order', 'stock_out')
WHERE o.status IN ('processing', 'ready for pick up')
GROUP BY o.id, o.order_id, o.name, o.status;
```

如果有记录，执行修复：

```sql
-- 修复订单状态
UPDATE orders
SET status = 'pending'
WHERE id IN (
    SELECT DISTINCT o.id
    FROM orders o
    INNER JOIN stock_transactions st ON st.order_id = o.order_id 
        AND st.transaction_type IN ('partial_delivery', 'manual_order', 'stock_out')
    WHERE o.status IN ('processing', 'ready for pick up')
);
```

---

### 步骤 2：处理芝士玉米烤肠的库存问题

#### 2.1 查看所有相关记录
在系统中：
```
库存管理 > 库存流水 > 搜索"芝士玉米烤肠"
```

记录下所有操作：
- [ ] 采购入库记录
- [ ] 客户订单出库记录
- [ ] 手动调整记录（重点！）
- [ ] 部分发货记录

#### 2.2 回滚错误的手动调整
找到之前因为供应商发错货而做的**错误调整**，逐条回滚：

**示例**：
```
假设之前的错误操作：
- 手动调整 -5（减少5件）← 回滚这个
- 手动调整 +3（增加3件）← 回滚这个
```

**操作**：
1. 找到这些手动调整记录
2. 点击每条记录右侧的"回滚"按钮
3. 确认回滚信息
4. 验证库存变化

#### 2.3 验证库存恢复
回滚后，芝士玉米烤肠的库存应该：
```
原库存 + 回滚恢复的数量 = 新库存
例如：0 + 5 - 3 = 2（假设回滚了-5和+3）
```

---

### 步骤 3：处理采购订单

#### 如果需要回滚采购订单入库
库存恢复后，你可以：

**方案A：回滚采购订单**
```
采购订单管理 > 找到对应的采购单 > 回滚整单
```

**方案B：保留采购订单，只调整数据**
```
如果采购订单数据正确，只回滚客户订单的错误发货即可
```

---

### 步骤 4：回滚有问题的客户订单发货

找到之前有问题的订单：
1. 在库存流水中搜索订单号
2. 找到"部分发货"或"订单出库"记录
3. 逐条回滚这些记录
4. 库存自动恢复

**现在支持回滚的类型**：
- ✅ 订单出库 (`order`)
- ✅ 部分发货 (`partial_delivery`)
- ✅ 手动扣库存 (`manual_order`)

---

### 步骤 5：重新测试部分发货

库存和订单状态都修复后：

1. **选择一个测试订单**
   - 选择一个待处理的订单
   - 确认库存充足

2. **执行部分发货**
   ```
   订单管理 > 找到订单 > 部分发货
   ```

3. **验证结果**
   - [ ] 库存正确减少
   - [ ] 订单状态显示"待处理"
   - [ ] 库存流水记录正确（数量为负数）

4. **如果还有问题**
   - 截图流水记录
   - 截图订单状态
   - 记录操作步骤
   - 联系技术支持

---

## 🎯 执行顺序总结

```
1. ⚠️ 执行SQL修复数据库 (Supabase)
   ├─ 修复库存流水数量符号
   └─ 修复订单状态

2. 🔄 回滚错误的手动调整 (系统界面)
   ├─ 查找芝士玉米烤肠的所有记录
   ├─ 识别错误的手动调整
   └─ 逐条回滚

3. ✅ 验证库存恢复
   └─ 检查芝士玉米烤肠库存是否正确

4. 📦 处理采购订单 (可选)
   └─ 回滚或保留，根据实际情况

5. 🔄 回滚有问题的客户订单发货
   ├─ 找到问题订单的发货记录
   └─ 逐条回滚

6. 🧪 重新测试部分发货
   ├─ 选择测试订单
   ├─ 执行部分发货
   └─ 验证所有数据正确

7. 🎉 完成！
```

---

## 📋 验证清单

完成后请检查：

### 数据库层面
- [ ] 所有出库记录的 quantity 都是负数
- [ ] 所有入库记录的 quantity 都是正数
- [ ] 有部分发货的订单状态是 'pending'

### 系统界面
- [ ] 芝士玉米烤肠库存数值正确
- [ ] 库存流水显示正确（+/- 符号正确）
- [ ] 订单管理中状态显示正确
- [ ] 回滚按钮可以正常使用

### 功能测试
- [ ] 可以回滚客户订单出库
- [ ] 可以回滚部分发货
- [ ] 可以回滚手动调整
- [ ] 可以回滚采购订单入库
- [ ] 部分发货后订单状态正确

---

## 🆘 遇到问题？

### 问题1：SQL执行报错
**解决**：
- 复制错误信息
- 检查表名和字段名
- 分步执行（先SELECT，后UPDATE）

### 问题2：回滚提示库存不足
**解决**：
- 先回滚其他记录增加库存
- 或手动临时增加库存
- 回滚完成后再调整

### 问题3：找不到要回滚的记录
**解决**：
- 确认产品名称完全匹配
- 检查是否已被回滚
- 查看所有流水记录而不只是筛选后的

### 问题4：回滚后订单状态还是不对
**解决**：
- 重新执行步骤1的SQL
- 清空浏览器缓存
- 刷新页面

---

## 💡 重要提示

1. **先修复数据库，再操作界面**
   - SQL修复是基础
   - 界面操作是后续步骤

2. **回滚操作不可撤销**
   - 确认后无法恢复
   - 建议先在测试订单上验证

3. **按顺序执行**
   - 不要跳过步骤
   - 每步完成后验证

4. **记录操作过程**
   - 截图关键步骤
   - 记录问题和解决方案
   - 方便后续查阅

---

## 🎊 完成后的成果

- ✅ 芝士玉米烤肠库存数据正确
- ✅ 所有库存流水显示正确
- ✅ 订单状态准确反映发货情况
- ✅ 可以正常回滚各种操作
- ✅ 部分发货功能正常工作
- ✅ 系统数据整洁一致

**祝你顺利解决问题！** 🚀

---

**创建时间**：2025-12-22  
**适用场景**：库存数据混乱、部分发货问题、回滚功能需求
