# 🔄 库存流水完整回滚功能 - 新版指南

## 🎊 新功能发布

### 现在支持所有类型的回滚！

之前版本只支持少数几种操作的回滚，现在**所有库存操作**都可以回滚了！

---

## ✅ 支持的回滚类型

### 客户订单相关
- ✅ **订单出库** (`order`) - 回滚POS销售
- ✅ **部分发货** (`partial_delivery`) - 回滚部分发货操作
- ✅ **手动扣库存** (`manual_order`) - 回滚手动订单扣减

### 库存调整相关
- ✅ **手动入库** (`stock_in`, `manual_in`) - 回滚手动增加库存
- ✅ **手动出库** (`stock_out`, `manual_out`) - 回滚手动减少库存
- ✅ **库存调整** (`stock_adjustment`) - 回滚库存数量调整

### 采购订单相关
- ✅ **采购入库** - 在"采购订单管理"中使用"回滚整单"或单条回滚

---

## 🚀 快速开始

### 步骤 1：进入库存管理
```
系统后台 > 库存管理 > 查看库存流水记录
```

### 步骤 2：找到要回滚的记录
- 使用搜索功能
- 查看"操作类型"、"原因"、"订单号"等信息

### 步骤 3：点击回滚按钮
- 每条记录右侧有"回滚"按钮
- 已回滚的显示为"已回滚"
- 不支持的显示为"不可回滚"

### 步骤 4：确认并执行
系统会显示详细确认信息，包括：
- 产品名称
- 操作类型
- 数量变化
- 订单号
- 回滚后的库存

---

## 🎯 典型使用场景

### 场景 1：修复供应商发错货
**你的情况**：芝士玉米烤肠库存为0，之前因为供应商发错货手动调整过

**解决方案**：
1. 在库存流水中找到"芝士玉米烤肠"的所有手动调整记录
2. 逐条回滚错误的调整记录
3. 库存恢复后，重新执行正确的入库操作

```
流水记录示例：
- 2025-12-20: 手动调整 -5（错误操作）→ 回滚此记录
- 2025-12-19: 手动调整 +3（错误操作）→ 回滚此记录
回滚后库存恢复，可以重新操作采购入库
```

### 场景 2：批量回滚部分发货
**你的情况**：某些订单的部分发货有问题，需要重新操作

**解决方案**：
1. 在库存流水中筛选"部分发货"类型
2. 找到问题订单的发货记录
3. 逐条回滚这些记录
4. 重新执行正确的部分发货操作
5. 执行 `fix-order-status-simple.sql` 修复订单状态

### 场景 3：采购订单回滚
**你的情况**：采购订单入库错误，需要回滚

**解决方案**：
```
采购订单管理 > 采购单列表 > 回滚整单按钮
```
一键回滚整个采购订单的所有入库记录

---

## 🔧 解决你的具体问题

### 问题：芝士玉米烤肠库存为0，无法回滚采购订单

**原因**：之前手动调整过库存，导致库存不足

**解决步骤**：

#### 步骤1：查找所有相关记录
在库存流水中搜索"芝士玉米烤肠"，查看所有记录：
- 采购入库记录
- 客户订单出库记录
- 手动调整记录

#### 步骤2：回滚错误的手动调整
找到之前因为供应商发错货而手动调整的记录，逐条回滚：
```
示例：
✓ 回滚：手动调整 -5（错误的减少）
✓ 回滚：手动调整 +3（错误的增加）
```

#### 步骤3：库存恢复后处理采购订单
库存恢复到正确数值后，你可以：
- 回滚采购订单的入库记录
- 或重新创建正确的采购订单

#### 步骤4：修复订单状态
执行SQL脚本修复订单状态：
```sql
-- 使用 fix-order-status-simple.sql
-- 将有部分发货记录的订单状态修正为 'pending'
```

---

## 🛡️ 安全保护机制

### 1. 防重复回滚
使用 `reversal_of` 字段标记：
- 每条回滚记录关联到原记录
- 已回滚的记录无法再次回滚
- 可以追踪完整的回滚历史

### 2. 库存不足保护
回滚前验证库存：
```
例如：回滚"手动出库 -10"需要增加10件库存
如果当前库存+10会超出合理范围，系统会提示
```

### 3. 详细的回滚记录
每条回滚都包含：
- 原交易的所有信息
- 回滚的原因和时间
- 关联的订单号
- 库存变化轨迹

---

## 📝 操作建议

### 回滚前的检查清单
- [ ] 确认这是正确的记录（产品、时间、数量）
- [ ] 了解回滚后的库存变化
- [ ] 确认没有其他依赖这条记录的操作
- [ ] 如果是订单相关，检查订单当前状态

### 回滚后的验证
- [ ] 查看库存是否正确恢复
- [ ] 检查是否创建了回滚记录
- [ ] 确认原记录已标记为"已回滚"
- [ ] 如果是订单相关，验证订单状态

### 批量回滚建议
如果需要回滚同一订单的多条记录：
1. 按时间从新到旧的顺序回滚
2. 每回滚一条，检查库存
3. 或使用"回滚整单"功能（采购订单）

---

## 🔍 如何查找要回滚的记录

### 按产品名称查找
在库存流水的搜索框输入产品名称，例如："芝士玉米烤肠"

### 按订单号查找
如果知道订单号，可以在备注中搜索

### 按操作类型筛选
- 只看"部分发货"
- 只看"手动调整"
- 只看"订单出库"

### 按时间排序
- 最新的记录在上面
- 方便找到最近的操作

---

## ⚠️ 重要提示

### 1. 回滚操作不可撤销
一旦确认回滚，无法恢复原状，只能：
- 手动重新创建相同的操作
- 或通过其他方式调整库存

### 2. 回滚不会自动更新订单状态
回滚部分发货后，订单状态可能不正确，需要：
- 执行 `fix-order-status-simple.sql` 修复
- 或手动更新订单状态

### 3. 回滚采购订单需要足够库存
如果库存已经售出，无法回滚采购入库，需要：
- 先回滚客户订单的出库记录
- 或手动补充库存后再回滚

### 4. 谨慎使用批量回滚
一次性回滚多条记录前：
- 先在数据库中查询确认
- 或逐条手动回滚（更安全）

---

## 💡 最佳实践

### 解决芝士玉米烤肠问题的完整流程

```
第1步：查找所有"芝士玉米烤肠"的库存记录
  ↓
第2步：识别错误的手动调整记录
  ↓
第3步：从最新到最旧逐条回滚错误记录
  ↓
第4步：验证库存恢复到合理数值
  ↓
第5步：处理采购订单（回滚或重建）
  ↓
第6步：执行SQL修复订单状态
  ↓
第7步：重新测试部分发货功能
```

---

## 🆘 故障排查

### 问题：点击回滚没有反应
**解决**：
- 检查浏览器控制台是否有错误
- 刷新页面重试
- 确认该记录确实支持回滚

### 问题：回滚提示库存不足
**解决**：
- 检查当前实际库存
- 先回滚其他消耗库存的记录
- 或手动增加库存后再回滚

### 问题：回滚后订单状态不对
**解决**：
- 执行 `fix-order-status-simple.sql`
- 或手动更新订单状态

### 问题：找不到要回滚的记录
**解决**：
- 确认记录确实存在
- 检查搜索关键词
- 查看是否已被回滚

---

## 📞 需要帮助？

遇到问题时：
1. 截图当前的库存流水
2. 记录想要回滚的操作
3. 说明遇到的错误提示
4. 联系技术支持

---

## ✅ 功能完成清单

现在你可以：
- ✅ 回滚所有类型的库存操作
- ✅ 修复供应商发错货的问题
- ✅ 批量回滚部分发货记录
- ✅ 重新测试订单发货流程
- ✅ 追踪完整的库存变更历史

**开始使用吧！** 🎉

---

**最后更新**：2025-12-22  
**文档版本**：2.0 - 完整回滚功能
