# 🔧 系统问题修复指南

## 📋 发现的问题

### 问题 1：库存流水数量显示错误
**现象**：
- 出库记录显示 `+1`（正数），但库存确实减少了
- 应该显示 `-1`（负数）才对

**原因**：
数据库中某些出库记录的 `quantity` 字段被错误地记录为正数。

**影响的记录类型**：
- `order` - 订单出库
- `stock_out` - 手动出库
- `manual_order` - 手动订单扣库存
- `partial_delivery` - 部分发货

**修复方法**：
执行 `fix-stock-transactions-quantity.sql` 脚本

---

### 问题 2：订单部分发货后状态不正确
**现象**：
- 订单部分发货后，流水记录显示"订单部分发货"
- 但订单管理页面状态没有显示为"部分发货"或"待处理"

**原因**：
部分发货后没有正确更新订单状态。

**修复方法**：
执行 `fix-order-partial-delivery-status.sql` 脚本

---

### 问题 3：回滚功能无法使用
**现象**：
- 点击"回滚"按钮后没有反应
- 或提示"没有找到要回滚的记录"

**原因分析**：
1. **在错误的位置寻找回滚功能**
   - 采购订单回滚功能在"采购订单管理 > 流水记录"标签页
   - 客户订单出库记录在"库存管理 > 库存流水"
   
2. **采购订单回滚 vs 客户订单回滚**
   - ✅ 采购订单回滚：撤销供应商进货入库
   - ❌ 客户订单回滚：目前不支持（需要单独实现）

---

## 🔍 详细分析

### 库存流水记录类型说明

| 类型 | 说明 | 数量符号 | 库存变化 |
|------|------|----------|----------|
| `stock_in` | 采购入库 | `+` 正数 | 增加 |
| `stock_out` | 手动出库 | `-` 负数 | 减少 |
| `order` | 订单出库 | `-` 负数 | 减少 |
| `manual_order` | 手动扣库存 | `-` 负数 | 减少 |
| `partial_delivery` | 部分发货 | `-` 负数 | 减少 |
| `manual_in` | 手动入库 | `+` 正数 | 增加 |
| `manual_adjustment` | 手动调整 | `+/-` 正负数 | 增减 |
| `stock_adjustment_reversal` | 调整回滚 | `+/-` 正负数 | 相反 |

### 订单状态流转

```
客户下单
  ↓
pending (待处理)
  ↓
[部分发货] → 保持 pending 状态，添加发货记录
  ↓
[再次部分发货] → 继续保持 pending 状态
  ↓
[全部发完] → delivered (已完成)
```

**关键点**：
- 部分发货不应该改变订单状态
- 只有全部商品发完才应该标记为 `delivered`

---

## 🛠️ 修复步骤

### 步骤 1：修复库存流水数量符号

1. 打开 Supabase SQL Editor
2. 复制并运行 `fix-stock-transactions-quantity.sql` 中的 SQL 语句
3. 按顺序执行：
   - 查看异常记录
   - 修复出库类型的正数错误
   - 修复入库类型的负数错误
   - 验证结果

**预期结果**：
- 所有出库记录的 `quantity` 为负数
- 所有入库记录的 `quantity` 为正数
- 流水显示中出库显示红色负数，入库显示绿色正数

---

### 步骤 2：修复订单部分发货状态

1. 打开 Supabase SQL Editor
2. 复制并运行 `fix-order-partial-delivery-status.sql` 中的 SQL 语句
3. 按顺序执行：
   - 查找有部分发货但状态错误的订单
   - 自动修复状态为 pending
   - 验证结果

**预期结果**：
- 有部分发货记录的订单状态为 `pending`
- 完全发货的订单状态为 `delivered`

---

### 步骤 3：测试回滚功能

**测试采购订单回滚**：
1. 进入"库存管理 > 采购订单管理"
2. 点击"流水记录"标签
3. 找到一条"入库"类型的记录
4. 点击"回滚"按钮
5. 确认回滚操作
6. 查看库存是否正确减少

**测试整单回滚**：
1. 在采购单列表找到"部分收货"或"已完成"的采购单
2. 点击红色"回滚整单"按钮
3. 查看确认对话框显示的产品列表
4. 确认回滚
5. 查看库存是否正确恢复

---

## ⚠️ 注意事项

### 关于客户订单回滚

目前系统**不支持**客户订单出库的回滚功能。如果需要：

1. **手动调整库存**：
   - 进入"库存管理"
   - 找到对应产品
   - 点击"手动调整库存"
   - 输入需要增加的数量
   - 填写原因："客户退货"或"订单取消"

2. **未来功能**（需要开发）：
   - 订单取消自动退还库存
   - 部分退货功能
   - 订单出库回滚功能

### 数据备份

在执行任何修复脚本前，建议：
1. 导出 `stock_transactions` 表数据
2. 导出 `orders` 表数据
3. 保存备份以防需要恢复

```sql
-- 备份 stock_transactions
COPY (SELECT * FROM stock_transactions ORDER BY created_at DESC) 
TO '/path/to/stock_transactions_backup.csv' CSV HEADER;

-- 备份 orders
COPY (SELECT * FROM orders ORDER BY created_at DESC) 
TO '/path/to/orders_backup.csv' CSV HEADER;
```

---

## 📊 验证清单

修复完成后，请检查：

- [ ] 库存流水中出库记录显示为负数（红色）
- [ ] 库存流水中入库记录显示为正数（绿色）
- [ ] 部分发货的订单状态显示为"待处理"
- [ ] 完全发货的订单状态显示为"已完成"
- [ ] 采购订单的回滚功能正常工作
- [ ] 整单回滚功能正常工作
- [ ] 防重复回滚机制生效

---

## 🆘 常见问题

### Q1: 为什么有些订单出库显示正数？
A: 这是历史数据问题，可能是早期代码bug导致。运行 `fix-stock-transactions-quantity.sql` 可以批量修复。

### Q2: 部分发货后为什么订单状态没变化？
A: 部分发货后应该**保持** `pending` 状态，不应该变成 `ready for pick up`。如果状态错误，运行 `fix-order-partial-delivery-status.sql` 修复。

### Q3: 为什么客户订单出库记录无法回滚？
A: 目前回滚功能只支持采购订单入库记录。客户订单出库需要通过"手动调整库存"来恢复。

### Q4: 如何区分采购入库和客户出库？
A: 
- 采购入库：在"采购订单管理 > 流水记录"
- 客户出库：在"库存管理 > 库存流水"中，类型为"订单出库"、"部分发货"等

### Q5: 回滚后能再次回滚吗？
A: 不能！回滚操作使用 `reversal_of` 字段标记，系统会自动防止重复回滚。

---

## 📝 后续改进建议

1. **统一库存流水管理**
   - 合并"库存流水"和"采购流水"到一个界面
   - 按类型分类显示（入库/出库/调整/回滚）

2. **订单出库回滚**
   - 实现客户订单出库的回滚功能
   - 支持部分退货
   - 自动更新订单状态

3. **数据一致性检查**
   - 定期检查数量符号是否正确
   - 检查订单状态与发货记录是否匹配
   - 自动修复常见错误

4. **操作日志**
   - 记录所有库存变更操作
   - 记录操作人和操作时间
   - 便于审计和问题排查

---

## ✅ 总结

**主要问题**：
1. ❌ 库存流水数量符号错误（出库显示正数）
2. ❌ 订单部分发货后状态未更新
3. ⚠️ 客户订单出库无法回滚（功能缺失）

**解决方案**：
1. ✅ 运行 SQL 脚本修复数量符号
2. ✅ 运行 SQL 脚本修复订单状态
3. 📌 使用手动调整库存临时解决
4. 🔜 未来开发订单出库回滚功能

---

**如需帮助，请查看**：
- `ROLLBACK-FEATURE.md` - 回滚功能技术文档
- `ROLLBACK-GUIDE.md` - 回滚功能使用指南
- `fix-stock-transactions-quantity.sql` - 数量修复脚本
- `fix-order-partial-delivery-status.sql` - 状态修复脚本
